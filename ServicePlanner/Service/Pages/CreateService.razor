@page "/create-service"

@using ServicePlanner.Bulletin
@using ServicePlanner.Data
@using ServicePlanner.Service.Wizard.General
@using ServicePlanner.Service.Wizard.OrderOfService

@inject IJSRuntime Js
@inject PdfService PdfService
@inject IStringLocalizer<Strings> Localize
@inject DataContext Context

<Wizard OnFinish="HandleServiceCreation">
    <WizardStep Name="@Localize["ServiceWizard.Step.General.Title"]">
        <GeneralEditor Service="Service" />
    </WizardStep>
    <WizardStep Name="@Localize["ServiceWizard.Step.OrderOfService.Title"]">
        <OrderOfServiceEditor Service="Service"/>
    </WizardStep>
</Wizard>

@code {
    private Data.Service.Service Service { get; } = new() {Date = DateTime.Today };

    private void HandleServiceCreation()
    {
        var data = new BulletinData() { Service = Service };

        if (Context.Institutions.Count() > 0)
        {
            data.Institution = Context.Institutions.First();
        }

        data.Service = Service;

        var pdfData = PdfService.GenerateBulletinPdf(data);
        DownloadFile(pdfData);
    }

    private void DownloadFile(byte[] pdfData)
    {
        FileUtility.SaveAs(Js, "Service.pdf", pdfData);
    }
}
